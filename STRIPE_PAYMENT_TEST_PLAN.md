# Stripe 沙箱支付测试计划

## 测试环境配置

### 已完成的配置
✅ 统一支付货币为CNY，价格¥19.90  
✅ 环境变量配置（Stripe测试密钥）  
✅ API端点部署到Vercel  
✅ 前端构建和类型检查  

### 下一步需要完成的配置
- [ ] 等待Vercel自动部署完成
- [ ] 验证环境变量在Vercel中正确设置
- [ ] 确认API端点可以正常访问

## 支付流程测试清单

### 1. 基础支付功能测试

#### 测试用例1: 创建支付会话
- **测试步骤**:
  1. 完成ECR评估并到达报告页面
  2. 点击"解锁详细报告"按钮（¥19.90）
  3. 验证跳转到Stripe Checkout页面
  4. 确认显示价格为¥19.90

- **期望结果**: 成功创建支付会话，价格显示正确

#### 测试用例2: 支付成功流程
- **测试步骤**:
  1. 在Stripe Checkout页面使用测试卡号
  2. 卡号: `4242 4242 4242 4242`
  3. 过期日期: 任意未来日期
  4. CVC: 任意3位数字
  5. 完成支付

- **期望结果**: 
  - 支付成功
  - 重定向到成功页面
  - 报告解锁，可查看详细内容
  - 本地存储保存访问令牌

#### 测试用例3: 支付取消流程
- **测试步骤**:
  1. 进入Stripe Checkout页面
  2. 点击"取消"或浏览器返回按钮
  3. 验证返回到报告页面

- **期望结果**:
  - 重定向到取消页面
  - 报告仍然锁定
  - 可以重新尝试支付

### 2. 错误处理测试

#### 测试用例4: 支付失败
- **测试步骤**:
  1. 使用被拒绝的测试卡号 `4000 0000 0000 0002`
  2. 尝试完成支付

- **期望结果**: 显示支付失败错误信息

#### 测试用例5: 网络错误
- **测试步骤**:
  1. 断开网络连接
  2. 尝试发起支付

- **期望结果**: 显示网络错误提示

### 3. 业务逻辑测试

#### 测试用例6: 重复支付检测
- **测试步骤**:
  1. 完成一次成功支付
  2. 再次尝试为同一评估付费

- **期望结果**: 
  - 按钮显示"已购买"
  - 不允许重复支付

#### 测试用例7: 访问令牌过期
- **测试步骤**:
  1. 修改本地存储中的过期时间为过去时间
  2. 刷新页面查看报告

- **期望结果**: 报告重新锁定，需要重新支付

### 4. 移动端兼容性测试

#### 测试用例8: 移动设备支付
- **测试步骤**:
  1. 在移动设备上完成评估
  2. 进行支付流程测试

- **期望结果**: 支付流程在移动端正常工作

## 测试用例数据

### Stripe 测试卡号
```
成功支付: 4242 4242 4242 4242
支付失败: 4000 0000 0000 0002
需要验证: 4000 0025 0000 3155
余额不足: 4000 0000 0000 9995
```

### 测试评估ID
```
test_assessment_20241129_001
test_assessment_20241129_002
```

## 验证检查点

### 前端验证
- [ ] 支付按钮显示正确价格 ¥19.90
- [ ] 加载状态和错误提示正常显示
- [ ] 支付成功后按钮状态更新为"已购买"
- [ ] 报告解锁后内容正常显示

### 后端验证
- [ ] 支付会话创建成功
- [ ] 支付验证逻辑正确
- [ ] 访问令牌生成和验证正常
- [ ] 错误处理和日志记录完整

### Stripe Dashboard验证
- [ ] 支付事件在Stripe测试环境中正确记录
- [ ] 金额和货币信息正确
- [ ] 元数据包含评估ID等信息

## 潜在问题和解决方案

### 常见问题
1. **CORS错误**: 检查API端点的CORS配置
2. **环境变量未设置**: 确认Vercel环境变量配置
3. **支付回调失败**: 检查URL配置和路由设置
4. **会话过期**: 确认30分钟过期机制正常工作

### 调试方法
1. 检查浏览器控制台错误日志
2. 查看Vercel函数日志
3. 检查Stripe Dashboard的事件日志
4. 验证本地存储数据结构

## 测试完成标准

### 必须通过的测试
- [ ] 基础支付功能（测试用例1-3）
- [ ] 错误处理（测试用例4-5）
- [ ] 重复支付检测（测试用例6）

### 建议完成的测试
- [ ] 移动端兼容性（测试用例8）
- [ ] 访问令牌管理（测试用例7）

测试完成后，支付系统即可用于生产环境的沙箱测试。