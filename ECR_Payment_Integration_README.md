# ECR亲密关系测评 - 微信支付集成说明

## 功能概述

本项目已成功集成微信支付功能，用户在查看详细报告前需要完成支付。支付成功后，用户可以查看完整的专业心理分析报告。

## 新增功能

### 1. 付费模态框
- 专业版报告介绍
- 价格展示（¥19.9，原价¥39.9）
- 微信支付二维码生成
- 支付状态实时检查
- 安全保障说明

### 2. 支付流程
1. 用户点击"查看详细报告"按钮
2. 显示付费模态框，介绍专业版报告内容
3. 用户点击"生成支付二维码"
4. 系统调用后端API生成微信支付二维码
5. 用户使用微信扫码支付
6. 系统轮询检查支付状态
7. 支付成功后自动显示详细报告

### 3. 调试功能
- 调试按钮：直接跳转到结果页面并绕过支付
- 模拟支付成功：在付费页面快速测试支付流程

## 技术实现

### 前端功能
- `showPaymentModal()`: 显示付费模态框
- `generatePaymentQR()`: 生成支付二维码
- `checkPaymentStatus()`: 检查支付状态
- `handlePaymentSuccess()`: 处理支付成功
- 支付状态管理和UI更新

### 后端API要求

#### 1. 创建支付订单
```
POST /api/payment/create
Content-Type: application/json

{
    "orderId": "ECR_1234567890_abc123",
    "amount": 1990,
    "description": "ECR亲密关系测评详细报告",
    "notifyUrl": "https://your-domain.com/api/payment/notify",
    "returnUrl": "https://your-domain.com/payment/return",
    "tradeType": "NATIVE"
}
```

响应：
```json
{
    "success": true,
    "qrCodeUrl": "weixin://wxpay/bizpayurl?pr=abc123",
    "orderId": "ECR_1234567890_abc123",
    "prepayId": "wx123456789"
}
```

#### 2. 查询支付状态
```
GET /api/payment/status/{orderId}
```

响应：
```json
{
    "success": true,
    "status": "SUCCESS",
    "orderId": "ECR_1234567890_abc123",
    "transactionId": "wx_transaction_123"
}
```

#### 3. 支付结果通知（微信回调）
```
POST /api/payment/notify
```

## 微信支付配置

### 必需的配置信息
- 微信商户号 (mch_id)
- 微信应用ID (app_id)  
- 商户API密钥 (api_key)
- 商户证书文件

### 微信商户平台配置
1. 配置支付授权目录
2. 设置支付回调URL
3. 上传商户证书
4. 配置退款账户（可选）

## 安全考虑

1. **前端安全**
   - 所有支付相关操作通过后端API
   - 前端不存储敏感支付信息
   - 支付状态通过服务器验证

2. **后端安全**
   - 验证微信支付签名
   - 防止重复支付
   - 订单状态管理
   - 支付金额验证

3. **数据保护**
   - HTTPS传输
   - 支付数据加密
   - 用户隐私保护

## 部署说明

### 开发环境
1. 直接打开HTML文件即可测试基本功能
2. 使用调试按钮测试支付流程
3. 模拟支付成功功能用于开发调试

### 生产环境
1. 部署后端API服务
2. 配置微信支付参数
3. 设置HTTPS域名
4. 配置支付回调地址
5. 测试完整支付流程

## 故障排除

### 常见问题
1. **二维码无法生成**
   - 检查后端API是否正常
   - 验证微信支付配置
   - 查看网络连接

2. **支付状态检查失败**
   - 确认订单ID正确
   - 检查支付状态API
   - 验证微信回调设置

3. **支付成功但状态未更新**
   - 检查微信支付回调
   - 验证签名算法
   - 查看服务器日志

### 调试工具
- 浏览器开发者工具
- 微信支付调试工具
- 后端API日志
- 微信商户平台交易记录

## 联系支持

如需技术支持或有任何问题，请联系开发团队。

---

**注意**: 本文档提供的是集成指南，实际部署时请根据具体需求调整配置和实现细节。
